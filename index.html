<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Media</title>
  <meta name="referrer" content="no-referrer-when-downgrade">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.15/dist/hls.min.js"></script>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://apiv.nyanx.de" crossorigin>
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    :root {
      --yt-red: #ff0000;
      --bg-dark: #000000;
      --panel-bg: rgba(28, 28, 28, 0.95);
      --border-light: rgba(255, 255, 255, 0.1);
      --ease-click: cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100dvh;
      width: 100%;
      background: var(--bg-dark);
      color: #fff;
      font-family: -apple-system, sans-serif;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .search-container {
      flex: 0 0 auto;
      padding: calc(env(safe-area-inset-top, 0px) + 15px) 20px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1000;
    }

    .search-box {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 6px 16px;
      width: 100%;
      max-width: 500px;
      border: 1px solid var(--border-light);
    }

    .search-box input {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 15px;
      padding: 4px 0;
      width: 100%;
      outline: none;
    }

    .search-box svg {
      fill: rgba(255, 255, 255, 0.5);
      margin-right: 10px;
      flex-shrink: 0;
    }

    .search-results-overlay {
      position: absolute;
      top: 65px;
      width: calc(100% - 40px);
      max-width: 500px;
      background: var(--panel-bg);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      max-height: 350px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.9);
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-item {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .result-item:hover { background: rgba(255, 255, 255, 0.05); }
    .result-item b { color: var(--yt-red); }

    .main-player-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 0 20px;
    }

    .player-stabilizer {
      width: 100%;
      max-width: 860px;
      display: flex;
      flex-direction: column;
    }

    #videoTitle {
      font-size: 11px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      text-align: center;
      margin-bottom: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .video-wrapper {
      position: relative;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      aspect-ratio: 16 / 9;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      will-change: transform;
      -webkit-backface-visibility: hidden;
      -webkit-perspective: 1000;
      backface-visibility: hidden;
      perspective: 1000;
    }

    .controls-panel {
      width: 100%;
      background: var(--panel-bg);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      padding: 16px;
      margin-top: 15px;
      border-radius: 20px;
      border: 1px solid var(--border-light);
    }

    .progress-wrapper {
      width: 100%;
      height: 20px;
      display: flex;
      align-items: center;
      cursor: pointer;
      touch-action: none;
      position: relative;
      padding: 10px 0;
      margin: -10px 0;
    }

    .progress-container {
      width: 100%;
      height: 5px;
      background: rgba(255, 255, 255, 0.1);
      position: relative;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-buffer {
      position: absolute;
      height: 100%;
      background: rgba(255, 255, 255, 0.15);
    }

    .progress-bar {
      height: 100%;
      background: var(--yt-red);
      width: 0%;
      position: relative;
    }

    .seek-row {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
      margin: 10px 0 15px;
    }

    .seek-btn {
      background: rgba(255, 255, 255, 0.08);
      border: none;
      color: #bbb;
      padding: 10px 0;
      font-size: 10px;
      border-radius: 10px;
      font-weight: 700;
      transition: all 0.1s var(--ease-click);
    }

    .seek-btn:active {
      transform: scale(0.92);
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }

    .bottom-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 40px;
    }

    .btn-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn {
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      transition: 0.1s;
    }

    .btn:active {
      transform: scale(0.85);
      opacity: 0.7;
    }

    .btn svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }

    #volSlider {
      -webkit-appearance: none;
      appearance: none;
      width: 70px;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }

    #volSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: #fff;
      border-radius: 50%;
    }

    #volSlider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: #fff;
      border-radius: 50%;
      border: none;
    }

    #volSlider::-moz-range-track {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      #volSlider { display: none !important; }
      .btn-group { gap: 8px; }
    }

    #timeBox {
      font-size: 12px;
      color: #999;
      font-variant-numeric: tabular-nums;
    }

    #speedBtn {
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 2px 8px;
      font-size: 11px;
    }

    .state-overlay {
      position: absolute;
      pointer-events: none;
      z-index: 10;
    }

    .center-btn {
      width: 66px;
      height: 66px;
      background: rgba(255, 0, 0, 0.9);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--yt-red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .speed-menu {
      position: absolute;
      bottom: 60px;
      right: 0;
      background: #222;
      border-radius: 14px;
      display: none;
      flex-direction: column;
      border: 1px solid #333;
      z-index: 100;
      overflow: hidden;
    }

    .speed-menu.show { display: flex; }

    .speed-item {
      padding: 12px 25px;
      font-size: 13px;
      cursor: pointer;
      text-align: center;
      border-bottom: 1px solid #333;
    }

    .speed-item.active {
      color: var(--yt-red);
      background: #2a2a2a;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="search-container">
    <div class="search-box">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
      </svg>
      <input type="text" id="searchInput" placeholder="输入关键词搜索..." autocomplete="off">
    </div>
    <div id="resultsList" class="search-results-overlay"></div>
  </div>

  <div class="main-player-area">
    <div class="player-stabilizer" id="playerNode">
      <div id="videoTitle">READY</div>
      <div class="video-wrapper" id="screen">
        <video id="video" playsinline webkit-playsinline></video>
        <div class="state-overlay">
          <div class="center-btn" id="centerPlayIcon">
            <svg viewBox="0 0 24 24" width="32" height="32" fill="white">
              <path d="M8 5v14l11-7z" />
            </svg>
          </div>
          <div id="loader" class="hidden">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
      <div class="controls-panel">
        <div class="progress-wrapper" id="progressWrap">
          <div class="progress-container">
            <div class="progress-buffer" id="bufferBar"></div>
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>
        <div class="seek-row">
          <button class="seek-btn" onclick="window.seek(-600)">-10m</button>
          <button class="seek-btn" onclick="window.seek(-60)">-1m</button>
          <button class="seek-btn" onclick="window.seek(-10)">-10s</button>
          <button class="seek-btn" onclick="window.seek(10)">+10s</button>
          <button class="seek-btn" onclick="window.seek(60)">+1m</button>
          <button class="seek-btn" onclick="window.seek(600)">+10m</button>
        </div>
        <div class="bottom-row">
          <div class="btn-group">
            <button class="btn" id="playBtn">
              <svg id="pIcon" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z" />
              </svg>
            </button>
            <button class="btn" id="nextBtn">
              <svg viewBox="0 0 24 24">
                <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
              </svg>
            </button>
            <div class="btn-group">
              <button class="btn" id="volBtn"><svg id="vIcon" viewBox="0 0 24 24"></svg></button>
              <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.5">
            </div>
            <span id="timeBox">0:00 / 0:00</span>
          </div>
          <div class="btn-group" style="position: relative;">
            <div class="speed-menu" id="speedMenu">
              <div class="speed-item" data-val="0.5">0.5x</div>
              <div class="speed-item active" data-val="1.0">1.0x</div>
              <div class="speed-item" data-val="1.5">1.5x</div>
              <div class="speed-item" data-val="2.0">2.0x</div>
            </div>
            <button class="btn" id="speedBtn">1.0x</button>
            <button class="btn" id="pipBtn">
              <svg viewBox="0 0 24 24">
                <path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z" />
              </svg>
            </button>
            <button class="btn" id="fullBtn">
              <svg viewBox="0 0 24 24">
                <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const video = $('video'), bar = $('progressBar'), buf = $('bufferBar'), wrap = $('progressWrap');
    const volSlider = $('volSlider'), volBtn = $('volBtn'), searchInput = $('searchInput'), resultsList = $('resultsList');

    let hls = null, isDragging = false, isLoaded = false;
    let usedCodes = [];
    const API = "https://apiv.nyanx.de/";
    let wakeLock = null;

    function getNetworkQuality() {
      if ('connection' in navigator) {
        const connection = navigator.connection;
        const effectiveType = connection.effectiveType || 'unknown';
        const downlink = connection.downlink || 0;

        if (effectiveType === 'slow-2g' || effectiveType === '2g') {
          return 'poor';
        } else if (effectiveType === '3g' || downlink < 1.5) {
          return 'moderate';
        } else if (effectiveType === '4g' || downlink >= 1.5) {
          return 'good';
        }
      }
      return 'unknown';
    }

    function getHlsConfigForNetwork(networkQuality) {
      const baseConfig = {
        backBufferLength: 90,
        maxBufferLength: 30,
        maxMaxBufferLength: 60,
        liveSyncDurationCount: 3,
        maxLoadingDelay: 4,
        maxStarvationDelay: 3,
        abrEwmaFastLive: 1.0,
        abrEwmaSlowLive: 3.0,
        abrEwmaDefaultEstimate: 5e5,
        abrBandWidthFactor: 0.95,
        abrBandWidthUpFactor: 0.7,
        enableWorker: true,
        enableWebWorker: true,
        lowLatencyMode: false,
        progressive: true,
        forceKeyFrameOnDiscontinuity: true,
        maxBufferHole: 0.01,
        highBufferWatchdogPeriod: 2,
        nudgeMaxRetry: 3,
        maxFragLookUpTolerance: 0.01,
        startFragPrefetch: true,
        testBandwidth: true,
        nudgeOffset: 0.05,
        xhrSetup: function (xhr, url) {
          xhr.withCredentials = false;
          xhr.timeout = 20000;
          xhr.setRequestHeader('Accept', '*/*');
          xhr.setRequestHeader('Accept-Encoding', 'identity');
        },
        fragLoadingTimeOut: 20000,
        fragLoadingMaxRetry: 6,
        fragLoadingMaxRetryTimeout: 60000,
        levelLoadingTimeOut: 20000,
        levelLoadingMaxRetry: 3,
        levelLoadingMaxRetryTimeout: 60000,
        maxBufferSize: 60 * 1000 * 1000,
        appendErrorMaxRetry: 3,
        enableSoftwareAES: true,
        manifestLoadingTimeOut: 20000,
        manifestLoadingMaxRetry: 3,
        manifestLoadingMaxRetryTimeout: 60000,
        capLevelOnFPSDrop: false,
        capLevelToPlayerSize: false,
        initialLiveManifestSize: 1,
        enableCEA708Captions: false,
        enableEMSG: false,
        enableStats: false,
        timelineLifter: true,
        maxSeekHole: 1,
        levelLoadingLoadPolicy: {
          default: {
            maxTimeToFirstByte: 10000,
            maxLoadTime: 20000,
            timeoutRetryDelay: 1000,
            errorRetryDelay: 2000
          }
        },
        fragLoadingLoadPolicy: {
          default: {
            maxTimeToFirstByte: 10000,
            maxLoadTime: 20000,
            timeoutRetryDelay: 1000,
            errorRetryDelay: 2000
          }
        }
      };

      switch (networkQuality) {
        case 'poor':
          baseConfig.maxBufferLength = 30;
          baseConfig.backBufferLength = 10;
          baseConfig.abrBandWidthFactor = 0.5;
          baseConfig.abrEwmaDefaultEstimate = 2e5;
          baseConfig.startFragPrefetch = false;
          baseConfig.maxSeekHole = 5;
          baseConfig.fragLoadingMaxRetry = 15;
          baseConfig.levelLoadingMaxRetry = 15;
          break;
        case 'moderate':
          baseConfig.maxBufferLength = 60;
          baseConfig.backBufferLength = 20;
          baseConfig.abrBandWidthFactor = 0.7;
          baseConfig.abrEwmaDefaultEstimate = 5e5;
          baseConfig.startFragPrefetch = true;
          baseConfig.maxSeekHole = 3;
          baseConfig.fragLoadingMaxRetry = 10;
          baseConfig.levelLoadingMaxRetry = 10;
          break;
        case 'good':
          baseConfig.maxBufferLength = 90;
          baseConfig.backBufferLength = 30;
          baseConfig.abrBandWidthFactor = 0.95;
          baseConfig.abrEwmaDefaultEstimate = 1.5e6;
          baseConfig.startFragPrefetch = true;
          baseConfig.maxSeekHole = 1;
          baseConfig.fragLoadingMaxRetry = 5;
          baseConfig.levelLoadingMaxRetry = 5;
          break;
      }

      return baseConfig;
    }

    function handleHlsError(error) {
      console.error('HLS Error:', error);
      
      if (error.details) {
        console.error('Error Details:', error.details);
      }
      
      if (!error.fatal) {
        if (error.details === 'bufferStalledError' || error.details === 'bufferNudgeOnStall') {
          console.warn('Handling buffer stall error...');
          setTimeout(() => {
            if (!video.paused && video.currentTime === lastCurrentTime) {
              console.log('长时间缓冲停滞，建议手动刷新页面...');
            }
          }, 5000);
        } else if (error.details === 'fragLoadError') {
          console.warn('Fragment loading error, retrying...');
        }
        return;
      }
      
      switch(error.type) {
        case Hls.ErrorTypes.NETWORK_ERROR:
          console.warn('Fatal network error, try to recover');
          setTimeout(() => {
            if (hls) {
              hls.startLoad();
            }
          }, 2000);
          break;
        case Hls.ErrorTypes.MEDIA_ERROR:
          console.warn('Fatal media error, try to recover');
          setTimeout(() => {
            const currentSrc = video.src || (hls && hls.url);
            if (currentSrc) {
              startVideo(currentSrc, $('videoTitle').innerText, !video.paused);
            }
          }, 1000);
          break;
        default:
          console.error('Unrecoverable error, reload player');
          const currentSrc = video.src || (hls && hls.url);
          if (currentSrc) {
            startVideo(currentSrc, $('videoTitle').innerText, !video.paused);
          } else {
            console.log('无法恢复播放器，可手动刷新页面...');
          }
          break;
      }
    }

    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {});
        } catch (err) {}
      }
    }

    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        releaseWakeLock();
      } else if (!video.paused && isLoaded) {
        requestWakeLock();
      }
    });

    const fmt = s => {
      if (!s || isNaN(s)) return "0:00";
      const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), r = Math.floor(s % 60);
      return h > 0 ? `${h}:${m < 10 ? '0' + m : m}:${r < 10 ? '0' + r : r}` : `${m}:${r < 10 ? '0' + r : r}`;
    };

    function updateVolUI() {
      const v = video.volume, m = video.muted;
      const vIcon = $('vIcon');
      if (m || v === 0) {
        vIcon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.39-.81.62-1.72.62-2.7 0-3.17-2.11-5.85-5-6.71v2.06c1.38.86 2.31 2.36 2.31 4.1s-.93 3.24-2.31 4.1v2.06c2.89-.86 5-3.54 5-6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.52.52-.89 1.15-1.14 1.83h2.06c.13-.27.33-.52.58-.77l.01-.01L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>';
      } else if (v > 0.5) {
        vIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
      } else {
        vIcon.innerHTML = '<path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z"/>';
      }
      volSlider.value = m ? 0 : v;
    }

    async function playNext(keyword = "") {
      const loader = $('loader');
      loader.classList.remove('hidden');
      try {
        let url = "";
        const isSearch = keyword && keyword.trim() !== "";
        if (isSearch) {
          url = `miss-search.php?title=${encodeURIComponent(keyword.trim())}`;
        } else {
          url = `${API}?exclude=${usedCodes.join(',')}`;
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        const res = await fetch(url, {
          signal: controller.signal,
          method: 'GET',
          mode: 'cors',
          headers: {
            'Accept': 'application/json'
          }
        });

        clearTimeout(timeoutId);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const json = await res.json();
        let listData = [];
        if (isSearch) {
          if (json.success && Array.isArray(json.data)) listData = json.data;
          else if (Array.isArray(json)) listData = json;
          else throw new Error('Invalid response format');
        } else {
          if (json.m3u8 || json.m3u8_url) listData = [json];
        }

        if (listData.length > 0) {
          resultsList.innerHTML = '';
          listData.forEach(item => {
            const div = document.createElement('div');
            div.className = 'result-item';
            const title = item.title || item.name || "未知视频";
            const m3u8 = item.m3u8_url || item.m3u8;
            if (isSearch) {
              const regex = new RegExp(`(${keyword})`, 'gi');
              div.innerHTML = title.replace(regex, '<b>$1</b>');
            } else {
              div.innerText = title;
            }
            div.onclick = (e) => {
              e.stopPropagation();
              startVideo(m3u8, title);
              resultsList.style.display = 'none';
              searchInput.value = '';
            };
            resultsList.appendChild(div);
          });
          if (isSearch) resultsList.style.display = 'block';
          else if (!isSearch && listData.length === 1) startVideo(listData[0].m3u8_url || listData[0].m3u8, listData[0].title || listData[0].name);
        } else if (isSearch) {
          resultsList.innerHTML = '<div class="result-item">未找到相关视频</div>';
          resultsList.style.display = 'block';
        }
      } catch (e) {
        let errorMessage = "加载失败";
        if (e.name === 'AbortError') {
          errorMessage = "请求超时，请检查网络连接";
        } else if (e.message.includes('Failed to fetch')) {
          errorMessage = "网络连接失败，请检查网络设置";
        } else if (e.message.includes('CORS')) {
          errorMessage = "跨域请求被阻止，请使用代理或检查服务器配置";
        } else {
          errorMessage = e.message;
        }

        if (!keyword) {
          alert(errorMessage);
        } else {
          resultsList.innerHTML = `<div class="result-item">${errorMessage}</div>`;
          resultsList.style.display = 'block';
        }
      } finally {
        loader.classList.add('hidden');
      }
    }

    function startVideo(m3u8, name, auto = true) {
      if (!m3u8) return;
      
      if (hls) {
        hls.off(Hls.Events.ERROR);
        hls.off(Hls.Events.MANIFEST_PARSED);
        hls.off(Hls.Events.BUFFER_APPENDED);
        hls.off(Hls.Events.LEVEL_LOADED);
        hls.destroy();
        hls = null;
      }
      
      video.removeAttribute('src');
      video.load();
      
      isLoaded = true;
      $('videoTitle').innerText = (name || "VIDEO").split('_')[0].toUpperCase();
      let finalUrl = m3u8.replace("https://surrit.com/", "/s1/");

      const videoId = generateVideoId(m3u8);

      const networkQuality = getNetworkQuality();
      const hlsConfig = getHlsConfigForNetwork(networkQuality);

      const setup = () => {
        video.volume = volSlider.value;
        video.muted = true;
        updateVolUI();

        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');

        lastCurrentTime = video.currentTime || 0;

        const history = JSON.parse(localStorage.getItem('video_history') || '{}');
        if (history[videoId]) {
          const savedPosition = history[videoId];
          if (video.duration && savedPosition > video.duration - 10) {
            video.currentTime = 0;
          } else {
            video.currentTime = savedPosition;
          }
        }

        if (Hls.isSupported()) {
          hls.on(Hls.Events.LEVEL_LOADED, () => {
            preloadTimeRange(30);
            lastCurrentTime = video.currentTime || 0;
          });

          hls.on(Hls.Events.BUFFER_APPENDED, () => {
            preloadTimeRange(30);
          });
        } else {
          video.addEventListener('loadeddata', () => {
            preloadTimeRange(30);
            lastCurrentTime = video.currentTime || 0;
          });

          video.addEventListener('timeupdate', () => {
            preloadTimeRange(30);
          });
        }

        if (auto) {
          video.muted = true;
          updateVolUI();
          const playPromise = video.play();
          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                $('centerPlayIcon').classList.add('hidden');
                setTimeout(() => {
                  if (!video.muted && video.volume > 0) {
                    video.muted = false;
                  }
                }, 1000);
              })
              .catch(error => {
                video.muted = true;
                updateVolUI();
                video.play().then(() => {
                  $('centerPlayIcon').classList.add('hidden');
                }).catch(() => {
                  $('centerPlayIcon').classList.remove('hidden');
                });
              });
          }
        }
      };

      function preloadTimeRange(secondsToPreload) {
        if (video.readyState >= 1 && video.buffered.length > 0) {
          try {
            const bufferedEnd = video.buffered.end(video.buffered.length - 1);
            const targetTime = Math.min(video.duration || Infinity, video.currentTime + secondsToPreload);

            if (bufferedEnd < targetTime) {}
          } catch (e) {}
        }
      }

      function generateVideoId(url) {
        let hash = 0;
        for (let i = 0; i < url.length; i++) {
          const char = url.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash |= 0;
        }
        return url.length + '_' + Math.abs(hash).toString(36);
      }

      if (Hls.isSupported()) {
        hls = new Hls(hlsConfig);
        hls.loadSource(finalUrl);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, setup);
        hls.on(Hls.Events.ERROR, function (event, data) {
          handleHlsError(data);
        });
      } else {
        video.src = finalUrl;
        video.onloadedmetadata = setup;
      }
      localStorage.setItem('current_video', JSON.stringify({ m3u8, name, videoId }));
    }

    let wrapRect = null;

    function preloadAfterSeek(seekTime) {
      setTimeout(() => {
        if (video.buffered.length > 0) {
          const bufferedEnd = video.buffered.end(video.buffered.length - 1);
          const needPreload = Math.min(video.duration || Infinity, seekTime + 30);
          if (bufferedEnd < needPreload) {
            if (hls) {
              video.currentTime = video.currentTime;
            }
          }
        }
      }, 500);
    }

    const handleProgress = (e, isFinal = false) => {
      if (!wrapRect) wrapRect = wrap.getBoundingClientRect();
      let clientX;
      if (e.touches && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
      } else if (e.changedTouches && e.changedTouches.length > 0) {
        clientX = e.changedTouches[0].clientX;
      } else {
        clientX = e.clientX;
      }
      const p = Math.max(0, Math.min(1, (clientX - wrapRect.left) / wrapRect.width));
      const newTime = p * video.duration;
      
      if (isFinal) {
        if (!isNaN(newTime) && video.duration > 0) {
          video.currentTime = newTime;
        }
        isDragging = false;
        
        preloadAfterSeek(newTime);
      } else if (isDragging) {
        bar.style.width = (p * 100) + "%";
        $('timeBox').innerText = `${fmt(newTime)} / ${fmt(video.duration)}`;
      }
    };

    wrap.onmousedown = (e) => {
      e.preventDefault();
      if (!video.duration) return;
      isDragging = true;
      wrapRect = wrap.getBoundingClientRect();
      handleProgress(e);
      
      video.removeEventListener('timeupdate', updateProgressBar);
    };

    window.onmousemove = (e) => {
      if (isDragging) {
        handleProgress(e);
      }
    };

    window.onmouseup = (e) => {
      if (isDragging) {
        handleProgress(e, true);
        video.addEventListener('timeupdate', updateProgressBar);
      }
    };

    document.addEventListener('touchmove', function(e) {
      if (isDragging) {
        e.preventDefault();
      }
    }, { passive: false });

    wrap.ontouchstart = (e) => {
      e.preventDefault();
      if (!video.duration) return;
      isDragging = true;
      wrapRect = wrap.getBoundingClientRect();
      handleProgress(e);
      
      video.removeEventListener('timeupdate', updateProgressBar);
    };

    wrap.ontouchmove = (e) => {
      if (isDragging) {
        e.preventDefault();
        handleProgress(e);
      }
    };

    wrap.ontouchend = (e) => {
      if (isDragging) {
        handleProgress(e, true);
        video.addEventListener('timeupdate', updateProgressBar);
      }
    };
    
    wrap.ontouchcancel = (e) => {
      if (isDragging) {
        handleProgress(e, true);
        video.addEventListener('timeupdate', updateProgressBar);
      }
    };

    function updateProgressBar() {
      if (video.duration && video.duration > 0) {
        bar.style.width = (video.currentTime / video.duration * 100) + "%";
        if (video.buffered.length) {
          buf.style.width = (video.buffered.end(video.buffered.length - 1) / video.duration * 100) + "%";
        }
        lastCurrentTime = video.currentTime;
      } else {
        bar.style.width = "0%";
        buf.style.width = "0%";
      }
      $('timeBox').innerText = `${fmt(video.currentTime)} / ${fmt(video.duration)}`;
    }

    video.ontimeupdate = () => {
      const currentVideo = localStorage.getItem('current_video');
      if (currentVideo && !isDragging) {
        try {
          const data = JSON.parse(currentVideo);
          const history = JSON.parse(localStorage.getItem('video_history') || '{}');
          history[data.videoId] = video.currentTime;

          if (video.duration && video.currentTime > video.duration - 5) {
            delete history[data.videoId];
          }

          localStorage.setItem('video_history', JSON.stringify(history));
        } catch (e) {}
      }
    };

    video.onplaying = () => {
      $('pIcon').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
      $('centerPlayIcon').classList.add('hidden');
      requestWakeLock();
      const up = () => {
        if (!video.paused && !isDragging) {
          updateProgressBar();
          requestAnimationFrame(up);
        }
      };
      up();
    };

    video.onpause = () => {
      if (isLoaded) $('centerPlayIcon').classList.remove('hidden');
      $('pIcon').innerHTML = '<path d="M8 5v14l11-7z"/>';
      releaseWakeLock();
    };

    video.onended = () => {
      releaseWakeLock();

      const currentVideo = localStorage.getItem('current_video');
      if (currentVideo) {
        const data = JSON.parse(currentVideo);
        const history = JSON.parse(localStorage.getItem('video_history') || '{}');
        delete history[data.videoId];
        localStorage.setItem('video_history', JSON.stringify(history));
      }

      playNext();
    };

    $('screen').onclick = () => isLoaded ? (video.paused ? video.play() : video.pause()) : playNext();
    $('playBtn').onclick = () => isLoaded ? (video.paused ? video.play() : video.pause()) : playNext();
    $('nextBtn').onclick = () => playNext();
    $('speedBtn').onclick = (e) => { e.stopPropagation(); $('speedMenu').classList.toggle('show'); };
    $('pipBtn').onclick = async () => {
      try {
        await video.requestPictureInPicture();
      } catch (error) {}
    };

    $('fullBtn').onclick = () => {
      const node = $('playerNode');
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else if (video.webkitEnterFullscreen) {
        video.webkitEnterFullscreen();
      } else if (node.requestFullscreen) {
        node.requestFullscreen();
      } else if (node.webkitRequestFullscreen) {
        node.webkitRequestFullscreen();
      }
    };

    function isIOSDevice() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }

    document.addEventListener('fullscreenchange', () => {
      const playerNode = $('playerNode');

      if (document.fullscreenElement) {
        playerNode.classList.add('fullscreen');
      } else {
        playerNode.classList.remove('fullscreen');
      }
    });

    volSlider.oninput = (e) => { video.volume = e.target.value; video.muted = (video.volume === 0); updateVolUI(); };
    volBtn.onclick = () => { video.muted = !video.muted; updateVolUI(); };

    document.querySelectorAll('.speed-item').forEach(i => {
      i.onclick = (e) => {
        e.stopPropagation(); video.playbackRate = parseFloat(i.dataset.val);
        $('speedBtn').innerText = i.dataset.val + 'x';
        document.querySelectorAll('.speed-item').forEach(el => el.classList.remove('active'));
        i.classList.add('active'); $('speedMenu').classList.remove('show');
      };
    });

    document.addEventListener('keydown', (e) => {
      if (document.activeElement === searchInput) return;
      const k = e.key;
      if ([' ', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(k)) e.preventDefault();
      if (k === ' ' || k.toLowerCase() === 'k') isLoaded ? (video.paused ? video.play() : video.pause()) : playNext();
      if (k === 'ArrowLeft') seek(-10);
      if (k === 'ArrowRight') seek(10);
      if (k === 'ArrowUp') { video.volume = Math.min(1, video.volume + 0.1); video.muted = false; updateVolUI(); }
      if (k === 'ArrowDown') { video.volume = Math.max(0, video.volume - 0.1); updateVolUI(); }
      if (k.toLowerCase() === 'f') $('fullBtn').click();
      if (k.toLowerCase() === 'm') volBtn.click();
    });

    searchInput.onkeydown = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        playNext(searchInput.value.trim());
      }
      e.stopPropagation();
    };
    window.seek = s => video.currentTime += s;

    document.addEventListener('visibilitychange', function () {
      if (document.hidden) {
        if (!video.paused) {
          video.pause();
        }
      }
    });

    window.addEventListener('blur', function () {
      if (!video.paused) {
        video.pause();
      }
    });

    window.onclick = (e) => {
      if (!e.target.closest('.search-container')) resultsList.style.display = 'none';
      $('speedMenu').classList.remove('show');
    };

    window.onload = () => {
      if (isIOSDevice()) {
        document.body.classList.add('ios-device');
      }

      video.volume = 0.5;
      video.muted = true;
      updateVolUI();
      const saved = localStorage.getItem('current_video');
      if (saved) {
        const data = JSON.parse(saved);
        startVideo(data.m3u8, data.name, false);
      } else {
        playNext();
      }
      
      optimizeVideoPerformance();
    };

    function optimizeVideoPerformance() {
      video.setAttribute('preload', 'metadata');
      video.setAttribute('x-webkit-airplay', 'deny');
      
      video.style.transform = 'translateZ(0)';
      video.style.willChange = 'transform';
      
      window.addEventListener('online', function() {
        console.log('网络连接已恢复，重新优化播放参数');
        if (hls) {
          hls.recoverMediaError();
        }
      });
    }

    let lastCurrentTime = 0;
    let stallDetectionTimer = null;

    function monitorVideoPlayback() {
      if (!video || !video.duration || video.paused) {
        if (stallDetectionTimer) {
          clearTimeout(stallDetectionTimer);
          stallDetectionTimer = null;
        }
        return;
      }

      if (Math.abs(video.currentTime - lastCurrentTime) < 0.1) {
        if (stallDetectionTimer) {
          return;
        }

        stallDetectionTimer = setTimeout(() => {
          console.log('检测到视频长时间卡顿，建议手动刷新页面...');
        }, 10000);
      } else {
        lastCurrentTime = video.currentTime;
        if (stallDetectionTimer) {
          clearTimeout(stallDetectionTimer);
          stallDetectionTimer = null;
        }
      }
    }

    setInterval(monitorVideoPlayback, 3000);

    video.addEventListener('play', () => {
      lastCurrentTime = video.currentTime;
      if (stallDetectionTimer) {
        clearTimeout(stallDetectionTimer);
        stallDetectionTimer = null;
      }
    });

    video.addEventListener('pause', () => {
      if (stallDetectionTimer) {
        clearTimeout(stallDetectionTimer);
        stallDetectionTimer = null;
      }
    });

    video.addEventListener('seeked', () => {
      lastCurrentTime = video.currentTime;
    });
  </script>
</body>
</html>
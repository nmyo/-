<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Media</title>
  <meta name="referrer" content="no-referrer-when-downgrade">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.15/dist/hls.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.6.8/plyr.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.6.8/plyr.min.js"></script>
  <!-- 预加载关键资源 -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://apiv.nyanx.de" crossorigin>
  <!-- 移动端优化 -->
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    :root {
      --yt-red: #ff0000;
      --bg-dark: #000000;
      --panel-bg: rgba(28, 28, 28, 0.95);
      --border-light: rgba(255, 255, 255, 0.1);
      --ease-click: cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100dvh;
      width: 100%;
      background: var(--bg-dark);
      color: #fff;
      font-family: -apple-system, sans-serif;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* 搜索栏 */
    .search-container {
      flex: 0 0 auto;
      padding: calc(env(safe-area-inset-top, 0px) + 15px) 20px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1000;
    }

    .search-box {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 6px 16px;
      width: 100%;
      max-width: 500px;
      border: 1px solid var(--border-light);
    }

    .search-box input {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 15px;
      padding: 4px 0;
      width: 100%;
      outline: none;
    }

    .search-box svg {
      fill: rgba(255, 255, 255, 0.5);
      margin-right: 10px;
      flex-shrink: 0;
    }

    .search-results-overlay {
      position: absolute;
      top: 65px;
      width: calc(100% - 40px);
      max-width: 500px;
      background: var(--panel-bg);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      max-height: 350px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.9);
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-item {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .result-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .result-item b {
      color: var(--yt-red);
    }

    .main-player-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 0 20px;
      min-height: 0; /* 允许flex子项收缩 */
    }

    .player-stabilizer {
      width: 100%;
      max-width: 860px;
      display: flex;
      flex-direction: column;
      min-width: 0; /* 允许内容溢出时正确处理 */
    }

    #videoTitle {
      font-size: 11px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      text-align: center;
      margin-bottom: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .video-wrapper {
      position: relative;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      aspect-ratio: 16 / 9;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      max-width: 100%;
      width: 100%;
      height: auto;
      max-height: 70vh; /* 限制视频高度不超过视口的70% */
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* 移动端渲染优化 */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      will-change: transform;
      /* 硬件加速 */
      -webkit-backface-visibility: hidden;
      -webkit-perspective: 1000;
      backface-visibility: hidden;
      perspective: 1000;
    }
    
    /* 响应式设计：针对小屏幕设备优化 */
    @media (max-width: 768px) {
      .video-wrapper {
        max-height: 60vh; /* 在小屏幕上使用更小的高度 */
        aspect-ratio: 16 / 9;
      }
    }
    
    /* 针对横屏手机的优化 */
    @media (orientation: landscape) and (max-height: 500px) {
      .video-wrapper {
        max-height: 80vh;
        aspect-ratio: 16 / 9;
      }
    }

    .seek-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
    }



    .btn-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn {
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      transition: 0.1s;
    }

    .btn:active {
      transform: scale(0.85);
      opacity: 0.7;
    }

    .btn svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }



    #speedBtn {
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 2px 8px;
      font-size: 11px;
    }

    .state-overlay {
      position: absolute;
      pointer-events: none;
      z-index: 10;
    }

    .center-btn {
      width: 66px;
      height: 66px;
      background: rgba(255, 0, 0, 0.9);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--yt-red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .speed-menu {
      position: absolute;
      bottom: 60px;
      right: 0;
      background: #222;
      border-radius: 14px;
      display: none;
      flex-direction: column;
      border: 1px solid #333;
      z-index: 100;
      overflow: hidden;
    }

    .speed-menu.show {
      display: flex;
    }

    .speed-item {
      padding: 12px 25px;
      font-size: 13px;
      cursor: pointer;
      text-align: center;
      border-bottom: 1px solid #333;
    }

    .speed-item.active {
      color: var(--yt-red);
      background: #2a2a2a;
    }

    .hidden {
      display: none !important;
    }

    /* 控制面板样式 */
    /* 视频内部控件样式 */
    .video-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 20px 16px 12px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 20;
    }
    
    .video-controls.visible {
      opacity: 1;
    }
    
    .video-progress-wrapper {
      width: 100%;
      height: 3px;
      display: flex;
      align-items: center;
      cursor: pointer;
      touch-action: none;
      margin-bottom: 12px;
    }
    
    .video-progress-container {
      width: 100%;
      height: 3px;
      background: rgba(255, 255, 255, 0.3);
      position: relative;
      border-radius: 2px;
      overflow: hidden;
    }
    
    .video-progress-buffer {
      position: absolute;
      height: 100%;
      background: rgba(255, 255, 255, 0.5);
    }
    
    .video-progress-bar {
      height: 100%;
      background: var(--yt-red);
      width: 0%;
      position: relative;
    }
    
    .video-bottom-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .video-time-display {
      font-size: 12px;
      color: #fff;
      font-variant-numeric: tabular-nums;
      margin-right: 10px;
    }
    
    .video-play-btn {
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      transition: 0.1s;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-play-btn:active {
      transform: scale(0.85);
      opacity: 0.7;
    }
    
    .video-play-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
    
    /* 视频区域悬停效果 */
    .video-wrapper:hover .video-controls {
      opacity: 1;
    }
    
    /* 下一个视频按钮样式 - 放在播放按钮旁边 */
    #nextVideoBtn {
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      transition: 0.1s;
    }

    #nextVideoBtn:active {
      transform: scale(0.85);
      opacity: 0.7;
    }

    #nextVideoBtn svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }
    

    
    /* 针对触摸设备的优化 */
    @media (hover: none) and (pointer: coarse) {
      .video-controls {
        opacity: 0;
      }
      
      .video-controls.force-visible {
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <div class="search-container">
    <div class="search-box">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path
          d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
      </svg>
      <input type="text" id="searchInput" placeholder="输入关键词搜索..." autocomplete="off">
    </div>
    <div id="resultsList" class="search-results-overlay"></div>
  </div>

  <div class="main-player-area">
    <div class="player-stabilizer" id="playerNode">
      <div id="videoTitle">READY</div>

      <div class="video-wrapper" id="screen">
        <video id="video" playsinline webkit-playsinline data-poster="" preload="metadata" crossorigin="anonymous" style="--plyr-color-main: #ff0000; --plyr-captions-background: rgba(0, 0, 0, 0.5);"></video>
        <div class="state-overlay">
          <div class="center-btn" id="centerPlayIcon">
            <svg viewBox="0 0 24 24" width="32" height="32" fill="white">
              <path d="M8 5v14l11-7z" />
            </svg>
          </div>
          <div id="loader" class="hidden">
            <div class="spinner"></div>
          </div>
        </div>
        
        <!-- 视频内部控件 -->
        <div class="video-controls" id="videoControls">
          <div class="video-progress-wrapper" id="videoProgressWrap">
            <div class="video-progress-container">
              <div class="video-progress-buffer" id="videoBufferBar"></div>
              <div class="video-progress-bar" id="videoProgressBar"></div>
            </div>
          </div>
          
          <div class="video-bottom-controls">
            <div class="btn-group" style="display: flex; align-items: center; gap: 8px;">
              <div class="video-time-display" id="videoTimeDisplay">0:00 / 0:00</div>
              <button class="video-play-btn" id="videoPlayBtn">
                <svg id="videoPIcon" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z" />
                </svg>
              </button>
              <!-- 下一个视频按钮 -->
              <button class="btn" id="nextVideoBtn" title="下一个视频">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                  <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                </svg>
              </button>
              <button class="btn" id="videoVolBtn">
                <svg id="videoVIcon" viewBox="0 0 24 24">
                  <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                </svg>
              </button>
            </div>
            <div class="btn-group" style="display: flex; align-items: center; gap: 10px; position: relative;">
              <div class="speed-menu" id="speedMenu">
                <div class="speed-item" data-val="0.5">0.5x</div>
                <div class="speed-item active" data-val="1.0">1.0x</div>
                <div class="speed-item" data-val="1.5">1.5x</div>
                <div class="speed-item" data-val="2.0">2.0x</div>
              </div>
              <button class="btn" id="speedBtn">1.0x</button>
              <button class="btn" id="pipBtn">
                <svg viewBox="0 0 24 24">
                  <path
                    d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z" />
                </svg>
              </button>
              <button class="btn" id="fullBtn">
                <svg viewBox="0 0 24 24">
                  <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3z" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>


      <!-- 功能按钮组 -->

    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const video = $('video'); // 移除了不存在的progressBar、bufferBar和progressWrap引用
    const searchInput = $('searchInput'), resultsList = $('resultsList');

    let hls = null, isDragging = false, isLoaded = false, videoWrapRect = null;
    let usedCodes = [];
    const API = "https://apiv.nyanx.de/";
    let wakeLock = null;
    
    // 移动端网络状况检测
    function getNetworkQuality() {
      // 使用 Network Information API 检测网络状况
      if ('connection' in navigator) {
        const connection = navigator.connection;
        const effectiveType = connection.effectiveType || 'unknown';
        const downlink = connection.downlink || 0;
        
        if (effectiveType === 'slow-2g' || effectiveType === '2g') {
          return 'poor';
        } else if (effectiveType === '3g' || downlink < 1.5) {
          return 'moderate';
        } else if (effectiveType === '4g' || downlink >= 1.5) {
          return 'good';
        }
      }
      
      // 如果不支持 Network Information API，返回默认值
      return 'unknown';
    }
    
    // 根据网络状况调整HLS配置
    function getHlsConfigForNetwork(networkQuality) {
      const baseConfig = {
        // 缓冲区优化 - 减少缓冲区大小以适应移动端内存限制
        backBufferLength: 10, // 减少后缓冲区，节省内存
        maxBufferLength: 30, // 降低最大缓冲区长度，减少内存占用
        maxMaxBufferLength: 60, // 最大缓冲区长度上限
        // 加载策略 - 优化移动端网络适应性
        liveSyncDurationCount: 3, // 减少直播同步片段数，降低延迟
        maxLoadingDelay: 2, // 减少加载延迟
        maxStarvationDelay: 2, // 减少饥饿延迟
        // 自适应码率 - 针对移动端网络波动优化
        abrEwmaFastLive: 2.0, // 增加快速带宽估算时间常数，更稳定
        abrEwmaSlowLive: 5.0, // 增加慢速带宽估算时间常数，避免频繁切换
        abrEwmaDefaultEstimate: 5e5, // 默认带宽估算 (500 kbps)
        abrBandWidthFactor: 0.8, // 降低带宽使用因子，更保守地选择质量
        abrBandWidthUpFactor: 0.9, // 上调带宽因子
        // 性能优化
        enableWorker: true, // 使用web worker解码，减少主线程阻塞
        workerPath: null, // 使用默认worker路径
        enableWebWorker: true,
        lowLatencyMode: true, // 低延迟模式
        progressive: true, // 启用渐进式下载
        // 关键帧对齐
        forceKeyFrameOnDiscontinuity: true,
        // 网络请求优化
        maxBufferHole: 0.1, // 减小缓冲间隙，提高连续性
        highBufferWatchdogPeriod: 1, // 减少高缓冲监控周期
        // 优化加载行为
        startFragPrefetch: true, // 预加载第一个片段
        testBandwidth: true, // 测试带宽以选择合适的质量
        // 错误处理优化
        nudgeOffset: 0.1, // 减小调整同步偏移
        nudgeMaxRetry: 2, // 减少同步重试次数
        maxFragLookUpTolerance: 0.1, // 减小片段查找容差
        // 启用网络优化
        xhrSetup: function(xhr, url) {
          // 允许跨域请求，添加移动端网络优化
          xhr.withCredentials = false;
          // 设置请求超时时间
          xhr.timeout = 10000; // 10秒超时
        },
        // 启用后处理以优化性能
        fragLoadingTimeOut: 10000, // 片段加载超时
        fragLoadingMaxRetry: 2, // 片段加载最大重试次数
        fragLoadingMaxRetryTimeout: 30000, // 片段加载最大重试超时
        levelLoadingTimeOut: 10000, // 级别加载超时
        levelLoadingMaxRetry: 2, // 级别加载最大重试次数
        levelLoadingMaxRetryTimeout: 30000 // 级别加载最大重试超时
      };
      
      // 根据网络质量进一步调整配置
      switch(networkQuality) {
        case 'poor':
          // 网络状况差时，更保守的配置
          baseConfig.maxBufferLength = 20;
          baseConfig.backBufferLength = 5;
          baseConfig.abrBandWidthFactor = 0.6; // 更保守地选择质量
          baseConfig.abrEwmaDefaultEstimate = 3e5; // 300 kbps
          baseConfig.startFragPrefetch = false; // 不预加载第一个片段以节省流量
          break;
        case 'moderate':
          // 中等网络状况
          baseConfig.maxBufferLength = 30;
          baseConfig.backBufferLength = 10;
          baseConfig.abrBandWidthFactor = 0.7;
          baseConfig.abrEwmaDefaultEstimate = 5e5; // 500 kbps
          baseConfig.startFragPrefetch = true;
          break;
        case 'good':
          // 良好网络状况
          baseConfig.maxBufferLength = 45;
          baseConfig.backBufferLength = 15;
          baseConfig.abrBandWidthFactor = 0.9;
          baseConfig.abrEwmaDefaultEstimate = 1e6; // 1 Mbps
          baseConfig.startFragPrefetch = true;
          break;
      }
      
      return baseConfig;
    }

    // 申请屏幕唤醒锁
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
  
          });
        } catch (err) {
          // 无法申请屏幕唤醒锁
        }
      } else {

      }
    }

    // 释放屏幕唤醒锁
    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
      }
    }

    // 页面可见性变化时处理唤醒锁
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // 页面隐藏时释放唤醒锁
        releaseWakeLock();
      } else if (!video.paused && isLoaded) {
        // 页面可见且视频播放时重新申请唤醒锁
        requestWakeLock();
      }
    });

    const fmt = s => {
      if (!s || isNaN(s)) return "0:00";
      const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), r = Math.floor(s % 60);
      return h > 0 ? `${h}:${m < 10 ? '0' + m : m}:${r < 10 ? '0' + r : r}` : `${m}:${r < 10 ? '0' + r : r}`;
    };

    function updateVolUI() {
      const v = video.volume, m = video.muted;
      const volIcon = $('videoVIcon');
      if (!volIcon) return;
      
      if (m || v === 0) {
        // 静音状态图标
        volIcon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>';
      } else if (v > 0.5) {
        // 高音量状态图标
        volIcon.innerHTML = '<path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zM5 9v6h4l5 5V4L9 9H5z"/>';
      } else {
        // 低音量状态图标
        volIcon.innerHTML = '<path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm-4-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02s-1.02-3.29-2.5-4.03zM3 9v6h4l5 5V4L7 9H3z"/>';
      }
    }

    async function playNext(keyword = "") {
      const loader = $('loader');
      loader.classList.remove('hidden');
      try {
        let url = "";
        const isSearch = keyword && keyword.trim() !== "";
        if (isSearch) {
          url = `miss-search.php?title=${encodeURIComponent(keyword.trim())}`;
        } else {
          url = `${API}?exclude=${usedCodes.join(',')}`;
        }
        
        // 添加超时控制
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const res = await fetch(url, { 
          signal: controller.signal,
          method: 'GET',
          mode: 'cors',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        clearTimeout(timeoutId);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const json = await res.json();
        let listData = [];
        if (isSearch) {
          if (json.success && Array.isArray(json.data)) listData = json.data;
          else if (Array.isArray(json)) listData = json;
          else throw new Error('Invalid response format');
        } else {
          if (json.m3u8 || json.m3u8_url) listData = [json];
        }
        
        if (listData.length > 0) {
          resultsList.innerHTML = '';
          listData.forEach(item => {
            const div = document.createElement('div');
            div.className = 'result-item';
            const title = item.title || item.name || "未知视频";
            const m3u8 = item.m3u8_url || item.m3u8;
            if (isSearch) {
              const regex = new RegExp(`(${keyword})`, 'gi');
              div.innerHTML = title.replace(regex, '<b>$1</b>');
            } else {
              div.innerText = title;
            }
            div.onclick = (e) => {
              e.stopPropagation();
              startVideo(m3u8, title);
              resultsList.style.display = 'none';
              searchInput.value = '';
            };
            resultsList.appendChild(div);
          });
          if (isSearch) resultsList.style.display = 'block';
          else if (!isSearch && listData.length === 1) startVideo(listData[0].m3u8_url || listData[0].m3u8, listData[0].title || listData[0].name);
        } else if (isSearch) {
          resultsList.innerHTML = '<div class="result-item">未找到相关视频</div>';
          resultsList.style.display = 'block';
        } else {

        }
      } catch (e) {

        // 详细的错误处理
        let errorMessage = "加载失败";
        if (e.name === 'AbortError') {
          errorMessage = "请求超时，请检查网络连接";
        } else if (e.message.includes('Failed to fetch')) {
          errorMessage = "网络连接失败，请检查网络设置";
        } else if (e.message.includes('CORS')) {
          errorMessage = "跨域请求被阻止，请使用代理或检查服务器配置";
        } else {
          errorMessage = e.message;
        }
        
        if (!keyword) {
          alert(errorMessage);
        } else {
          resultsList.innerHTML = `<div class="result-item">${errorMessage}</div>`;
          resultsList.style.display = 'block';
        }
      } finally {
        loader.classList.add('hidden');
      }
    }

function startVideo(m3u8, name, auto = true) {
      if (!m3u8) return;
      if (hls) {
        hls.destroy();
      }
      // 移除之前的音量变化事件监听器
      video.removeEventListener('volumechange', updateVolUI);
      isLoaded = true;
      $('videoTitle').innerText = (name || "VIDEO").split('_')[0].toUpperCase();
      let finalUrl = m3u8.replace("https://surrit.com/", "/s1/");

      // 创建基于URL的唯一ID用于存储播放历史
      const videoId = generateVideoId(m3u8);

      // 获取当前网络状况并配置HLS参数
      const networkQuality = getNetworkQuality();
      const hlsConfig = getHlsConfigForNetwork(networkQuality);

      // 初始化Plyr播放器配置
      const playerSettings = {
        controls: [
          'play-large',
          'rewind',
          'play', 
          'fast-forward',
          'progress',
          'current-time',
          'duration',
          'mute',
          'volume',
          'pip',
          'airplay',
          'settings',
          'fullscreen'
        ],
        settings: ['quality', 'speed'],
        speed: {
          selected: 1,
          options: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2]
        },
        quality: {
          default: 576,
          options: [144, 240, 360, 480, 720, 1080]
        },
        i18n: {
          restart: '重新开始',
          rewind: '后退{seektime}s',
          play: '播放',
          pause: '暂停',
          fastForward: '快进{seektime}s',
          seek: 'Seek',
          played: 'Played',
          buffered: 'Buffered',
          currentTime: '当前时间',
          duration: '总时长',
          volume: '音量',
          mute: '静音',
          unmute: '取消静音',
          enableCaptions: '开启字幕',
          disableCaptions: '关闭字幕',
          download: '下载',
          enterFullscreen: '进入全屏',
          exitFullscreen: '退出全屏',
          frameTitle: '播放器窗口',
          captions: '字幕',
          settings: '设置',
          speed: '速度',
          quality: '画质',
          loop: '循环播放',
          start: '开始',
          end: '结束',
          all: '全部',
          reset: '重置',
          disabled: '关闭',
          advertisement: '广告'
        }
      };

      const setup = () => {
        // 初始化Plyr播放器
        if (window.player) {
          window.player.destroy();
        }
        
        window.player = new Plyr(video, playerSettings);
        
        video.volume = 0.5;
        video.muted = true; // 确保每次加载视频时都是静音状态
        updateVolUI();

        // 添加音量变化事件监听器
        video.addEventListener('volumechange', updateVolUI);

        // 移动端性能优化
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');

        // 尝试从本地存储恢复播放位置
        const history = JSON.parse(localStorage.getItem('video_history') || '{}');
        if (history[videoId]) {
          // 检查视频是否接近结尾，如果是则从头开始播放
          const savedPosition = history[videoId];
          if (video.duration && savedPosition > video.duration - 10) {
            video.currentTime = 0; // 如果距离结尾不到10秒，则从头开始
          } else {
            video.currentTime = savedPosition;
          }
        }

        // 监听元数据加载完成事件，此时可以获取准确的持续时间
        if (Hls.isSupported()) {
          // 在HLS模式下，我们监听LEVEL_LOADED事件来确认已缓存足够内容
          hls.on(Hls.Events.LEVEL_LOADED, () => {
            // 预缓存30秒内容
            preloadTimeRange(30);
          });

          // 监听缓冲区更新事件，持续确保有足够的预加载内容
          hls.on(Hls.Events.BUFFER_APPENDED, () => {
            preloadTimeRange(30);
          });
        } else {
          // 对于原生视频，直接尝试预缓存
          video.addEventListener('loadeddata', () => {
            preloadTimeRange(30);
          });

          // 监听时间更新，确保缓冲区充足
          video.addEventListener('timeupdate', () => {
            preloadTimeRange(30);
          });
        }

        if (auto) {
          // 移动端优化：先静音播放以绕过自动播放限制
          video.muted = true;
          updateVolUI();
          const playPromise = video.play();
          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                // 播放成功
                $('centerPlayIcon').classList.add('hidden');
                // 如果用户之前设置了非静音，则恢复音量
                setTimeout(() => {
                  if (!video.muted && video.volume > 0) {
                    video.muted = false;
                  }
                }, 1000);
              })
              .catch(error => {
                // 如果自动播放失败，尝试先静音再播放
                video.muted = true;
                updateVolUI();
                video.play().then(() => {
                  $('centerPlayIcon').classList.add('hidden');
                }).catch(() => {
                  // 如果仍然失败，显示播放按钮
                  $('centerPlayIcon').classList.remove('hidden');
                });
              });
          }
        }
      };

      // 预缓存指定时间段的函数
      function preloadTimeRange(secondsToPreload) {
        // 这个函数用于确保指定秒数的内容已被缓冲
        if (video.readyState >= 1 && video.buffered.length > 0) { // HAVE_METADATA及以上
          try {
            const bufferedEnd = video.buffered.end(video.buffered.length - 1);
            const targetTime = Math.min(video.duration || Infinity, video.currentTime + secondsToPreload);

            // 如果缓冲区未达到目标时间，则继续加载
            if (bufferedEnd < targetTime) {
              // HLS.js会自动管理缓冲区，这里主要是监控和记录

            }
          } catch(e) {
            // 处理可能的错误，例如在视频加载初期buffered.end可能不可用

          }
        }
      }

      // 生成视频的唯一ID用于存储播放历史
      function generateVideoId(url) {
        // 简单的哈希函数生成唯一ID
        let hash = 0;
        for (let i = 0; i < url.length; i++) {
          const char = url.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash |= 0; // 转换为32位整数
        }
        return url.length + '_' + Math.abs(hash).toString(36);
      }

      if (Hls.isSupported()) {
        hls = new Hls(hlsConfig);
        hls.loadSource(finalUrl);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, setup);
      } else {
        video.src = finalUrl;
        video.onloadedmetadata = setup;
      }
      localStorage.setItem('current_video', JSON.stringify({ m3u8, name, videoId }));
    }
    const handleProgress = (e, isFinal = false, targetWrap = null) => {
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const rect = targetWrap || videoWrapRect; // 使用videoWrapRect代替不存在的wrapRect
      const p = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
      
      // 更新内部进度条
      if (typeof $('videoProgressBar') !== 'undefined' && $('videoProgressBar')) {
        $('videoProgressBar').style.width = (p * 100) + "%";
      }
      
      if (isFinal) video.currentTime = p * video.duration;
    };

    // 内部进度条的鼠标事件处理
    const videoProgressWrap = $('videoProgressWrap');
    if (videoProgressWrap) {
      videoProgressWrap.onmousedown = (e) => {
        isDragging = true;
        videoWrapRect = videoProgressWrap.getBoundingClientRect();
        handleProgress(e, false, videoWrapRect);
      };
    }
    
    window.onmousemove = (e) => {
      if (isDragging) handleProgress(e);
    };
    
    window.onmouseup = (e) => {
      if (isDragging) {
        isDragging = false;
        handleProgress(e, true);
      }
    };
    
    // 内部进度条的触摸事件处理
    if (videoProgressWrap) {
      videoProgressWrap.ontouchstart = (e) => {
        isDragging = true;
        videoWrapRect = videoProgressWrap.getBoundingClientRect();
        handleProgress(e, false, videoWrapRect);
      };
    }
    
    // 内部进度条的触摸移动事件处理
    if (videoProgressWrap) {
      videoProgressWrap.ontouchmove = (e) => {
        if (isDragging) {
          e.preventDefault();
          handleProgress(e, false, videoWrapRect);
        }
      };
    }
    
    // 内部进度条的触摸结束事件处理
    if (videoProgressWrap) {
      videoProgressWrap.ontouchend = (e) => {
        if (isDragging) {
          isDragging = false;
          handleProgress(e, true, videoWrapRect);
        }
      };
    }

    video.ontimeupdate = () => {
      // 保存播放历史
      const currentVideo = localStorage.getItem('current_video');
      if (currentVideo && !isDragging) {
        try {
          const data = JSON.parse(currentVideo);
          const history = JSON.parse(localStorage.getItem('video_history') || '{}');
          // 使用视频ID作为键，而不是原始URL
          history[data.videoId] = video.currentTime;
          
          // 如果视频播放完毕（接近结尾），则从历史记录中移除
          if (video.duration && video.currentTime > video.duration - 5) {
            delete history[data.videoId]; // 播放完毕后清除历史记录
          }
          
          localStorage.setItem('video_history', JSON.stringify(history));
        } catch(e) {

        }
      }
    };

    video.onplaying = () => {
      $('videoPIcon').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
      $('centerPlayIcon').classList.add('hidden');
      updateVolUI(); // 更新音量图标
      // 视频播放时申请屏幕唤醒锁
      requestWakeLock();
      const up = () => {
        if (!video.paused && !isDragging) {
          if (video.duration && video.duration > 0) {
            // 更新内部进度条
            $('videoProgressBar').style.width = (video.currentTime / video.duration * 100) + "%";
            if (video.buffered.length) $('videoBufferBar').style.width = (video.buffered.end(video.buffered.length - 1) / video.duration * 100) + "%";
          } else {
            // 更新内部进度条
            $('videoProgressBar').style.width = "0%";
            $('videoBufferBar').style.width = "0%";
          }
          const timeText = `${fmt(video.currentTime)} / ${fmt(video.duration)}`;
          $('videoTimeDisplay').innerText = timeText;
          requestAnimationFrame(up);
        }
      };
      up();
    };

    video.onpause = () => {
      if (isLoaded) {
        $('centerPlayIcon').classList.remove('hidden');
        $('videoPIcon').innerHTML = '<path d="M8 5v14l11-7z"/>';
      }
      updateVolUI(); // 更新音量图标
      // 视频暂停时释放屏幕唤醒锁
      releaseWakeLock();
    };

    video.onended = () => { 
      // 视频结束时释放屏幕唤醒锁
      releaseWakeLock();
      
      // 从播放历史中清除当前视频的记录
      const currentVideo = localStorage.getItem('current_video');
      if (currentVideo) {
        const data = JSON.parse(currentVideo);
        const history = JSON.parse(localStorage.getItem('video_history') || '{}');
        delete history[data.videoId]; // 播放结束后清除历史记录
        localStorage.setItem('video_history', JSON.stringify(history));
        
        // 将已播放的视频代码添加到排除列表中
        if (data.m3u8) {
          const videoCode = extractVideoCode(data.m3u8);
          if (videoCode && !usedCodes.includes(videoCode)) {
            usedCodes.push(videoCode);
          }
        }
      }
      
      playNext(); 
    };
    
    // 从视频URL中提取视频代码的辅助函数
    function extractVideoCode(url) {
      // 从URL中提取视频代码，例如从 "https://example.com/video/abc123.m3u8" 提取 "abc123"
      const match = url.match(/\/([^\/]+\.m3u8)$/);
      if (match) {
        return match[1].replace('.m3u8', '');
      }
      // 如果上面的正则没匹配到，尝试其他常见格式
      const fallbackMatch = url.match(/([a-zA-Z0-9_-]+\.m3u8)$/);
      if (fallbackMatch) {
        return fallbackMatch[1].replace('.m3u8', '');
      }
      return url;
    }

    // 点击视频区域播放/暂停
    $('screen').onclick = (e) => {
      // 如果点击的是内部按钮，不执行此操作（防止重复）
      if (e.target.closest('#videoPlayBtn, #videoVolBtn, #speedBtn, #pipBtn, #fullBtn')) {
        return;
      }
      if (isLoaded) {
        if (video.paused) {
          video.play().catch(e => {
            console.error("Play error:", e);
            // 如果播放失败，可能需要先静音再播放
            video.muted = true;
            updateVolUI();
            video.play().catch(err => console.error("Play failed even when muted:", err));
          });
        } else {
          video.pause();
        }
      } else {
        playNext();
      }
    };
    
    // 内部播放按钮点击事件
    $('videoPlayBtn').onclick = (e) => {
      e.stopPropagation(); // 防止事件冒泡
      if (isLoaded) {
        if (video.paused) {
          video.play().catch(e => {
            console.error("Play error:", e);
            // 如果播放失败，可能需要先静音再播放
            video.muted = true;
            updateVolUI();
            video.play().catch(err => console.error("Play failed even when muted:", err));
          });
        } else {
          video.pause();
        }
      } else {
        playNext(); // 只有在未加载任何视频时才调用playNext
      }
    };
    // 内部音量按钮点击事件
    $('videoVolBtn').onclick = () => {
      video.muted = !video.muted;
      updateVolUI();
    };
    
    // 下一个视频按钮点击事件
    $('nextVideoBtn').onclick = (e) => {
      e.stopPropagation();
      playNext();
    };
    $('speedBtn').onclick = (e) => { e.stopPropagation(); $('speedMenu').classList.toggle('show'); };
    $('pipBtn').onclick = async () => {
      try {
        await video.requestPictureInPicture();
      } catch (error) {

      }
    };

    // 修复 iOS 全屏
    $('fullBtn').onclick = () => {
      const node = $('playerNode');
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else if (video.webkitEnterFullscreen) {
        // iOS iPhone 专用
        video.webkitEnterFullscreen();
      } else if (node.requestFullscreen) {
        node.requestFullscreen();
      } else if (node.webkitRequestFullscreen) {
        node.webkitRequestFullscreen();
      }
    };

    // 检测是否为 iOS 设备
    function isIOSDevice() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // 支持 iPadOS
    }
    
    // 全屏状态变化事件监听
    document.addEventListener('fullscreenchange', () => {
      const playerNode = $('playerNode');
      
      if (document.fullscreenElement) {
        // 进入全屏
        playerNode.classList.add('fullscreen');
      } else {
        // 退出全屏
        playerNode.classList.remove('fullscreen');
      }
    });



    document.querySelectorAll('.speed-item').forEach(i => {
      i.onclick = (e) => {
        e.stopPropagation(); video.playbackRate = parseFloat(i.dataset.val);
        $('speedBtn').innerText = i.dataset.val + 'x';
        document.querySelectorAll('.speed-item').forEach(el => el.classList.remove('active'));
        i.classList.add('active'); $('speedMenu').classList.remove('show');
      };
    });

    document.addEventListener('keydown', (e) => {
      if (document.activeElement === searchInput) return;
      const k = e.key;
      if ([' ', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(k)) e.preventDefault();
      if (k === ' ' || k.toLowerCase() === 'k') {
        if (isLoaded) {
          if (video.paused) {
            video.play().catch(e => {
              console.error("Play error:", e);
              // 如果播放失败，可能需要先静音再播放
              video.muted = true;
              updateVolUI();
              video.play().catch(err => console.error("Play failed even when muted:", err));
            });
          } else {
            video.pause();
          }
        } else {
          playNext();
        }
      }
      if (k === 'ArrowLeft') seek(-10);
      if (k === 'ArrowRight') seek(10);
      if (k.toLowerCase() === 'f') $('fullBtn').click();
    });

    searchInput.onkeydown = (e) => { 
      if (e.key === 'Enter') {
        e.preventDefault();
        playNext(searchInput.value.trim()); 
      }
      e.stopPropagation(); 
    };
    window.seek = s => video.currentTime += s;

    // 页面可见性变化事件监听 - 已禁用自动暂停功能
    /*
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        // 页面变为不可见（切换到其他标签页、最小化或进入后台）
        if (!video.paused) {
          video.pause();
        }
      }
    });
    */

    // 页面失焦时暂停播放 - 已禁用自动暂停功能
    /*
    window.addEventListener('blur', function() {
      if (!video.paused) {
        video.pause();
      }
    });
    */
    
    // 页面获得焦点时可以选择恢复播放（已禁用自动播放功能）
    /*
    window.addEventListener('focus', function() {
      // 可根据需求决定是否自动恢复播放
      // video.play();
    });
    */

    window.onclick = (e) => {
      if (!e.target.closest('.search-container')) resultsList.style.display = 'none';
      $('speedMenu').classList.remove('show');
    };

    // 视频控件自动隐藏功能
    let hideControlsTimeout;
    
    function showVideoControls() {
      const videoControls = $('videoControls');
      if (videoControls) {
        videoControls.classList.add('visible');
        
        // 对于触摸设备，使用force-visible类
        if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
          videoControls.classList.add('force-visible');
        }
      }
      
      // 清除之前的定时器
      if (hideControlsTimeout) {
        clearTimeout(hideControlsTimeout);
      }
      
      // 设置新的定时器来隐藏控件
      hideControlsTimeout = setTimeout(() => {
        if (!video.paused) { // 只有在播放状态下才自动隐藏
          const videoControls = $('videoControls');
          if (videoControls) {
            videoControls.classList.remove('visible');
            videoControls.classList.remove('force-visible');
          }
        }
      }, 3000); // 3秒后自动隐藏
    }
    
    function hideVideoControls() {
      const videoControls = $('videoControls');
      if (videoControls) {
        videoControls.classList.remove('visible');
        videoControls.classList.remove('force-visible');
      }
    }
    
    // 触摸设备上双击视频区域显示/隐藏控件
    let lastTouchTime = 0;
    $('screen').addEventListener('touchend', (e) => {
      // 避免与播放/暂停按钮冲突
      if (e.target.closest('.video-play-btn, .btn')) {
        return;
      }
      
      const now = new Date().getTime();
      if (now - lastTouchTime < 300) { // 双击间隔小于300ms
        e.preventDefault();
        const videoControls = $('videoControls');
        const nextVideoBtn = $('nextVideoBtn');
        if (videoControls && videoControls.classList.contains('visible')) {
          hideVideoControls(); // 如果控件可见则隐藏
          if (nextVideoBtn) nextVideoBtn.classList.remove('force-visible');
        } else {
          showVideoControls(); // 如果控件隐藏则显示
          if (nextVideoBtn) nextVideoBtn.classList.add('force-visible');
        }
        lastTouchTime = 0; // 重置双击计时
      } else {
        lastTouchTime = now;
      }
    });
    
    window.onload = () => {
      // 为iOS设备添加特定CSS类
      if (isIOSDevice()) {
        document.body.classList.add('ios-device');
      }
      
      // 添加视频区域的触摸和鼠标事件监听器
      const screen = $('screen');
      if (screen) {
        // 鼠标移动事件显示控件
        screen.addEventListener('mousemove', showVideoControls);
        screen.addEventListener('mouseleave', () => {
          if (!video.paused) {
            setTimeout(hideVideoControls, 1000); // 鼠标离开后短暂延迟隐藏
          }
        });
        
        // 触摸事件显示控件
        screen.addEventListener('touchstart', (e) => {
          // 避免与播放/暂停按钮和双击功能冲突
          if (e.target.closest('.video-play-btn, .btn')) {
            return; // 如果点击的是按钮，不触发显示控件
          }
          
          // 对于非双击的触摸，显示控件
          showVideoControls();
          
          // 显示下一个视频按钮
          const nextVideoBtn = $('nextVideoBtn');
          if (nextVideoBtn) {
            nextVideoBtn.classList.add('force-visible');
          }
        });
        
        // 在触摸设备上，当视频播放时自动隐藏控件
        if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
          video.addEventListener('play', () => {
            setTimeout(() => {
              if (!video.paused) {
                hideVideoControls();
              }
            }, 3000); // 播放开始后3秒自动隐藏
          });
          
          video.addEventListener('pause', () => {
            showVideoControls(); // 暂停时显示控件
          });
        }
      }
      
      video.volume = 0.5;
      video.muted = true; // 初始状态静音
      updateVolUI();
      const saved = localStorage.getItem('current_video');
      if (saved) {
        const data = JSON.parse(saved);
        startVideo(data.m3u8, data.name, false);
      } else {
        playNext();
      }
    };
  </script>
</body>

</html>

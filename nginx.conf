# --- 后端长连接优化 ---
upstream surrit_backend {
    server surrit.com:443;
    keepalive 64;
}

# --- HTTP 自动跳转 HTTPS ---
server {
    listen 80;
    listen [::]:80;
    server_tokens off;
    server_name videos.nyanx.de;
    return 301 https://$host$request_uri;
}

# --- HTTPS 核心配置 ---
server {
    listen 443 ssl http2;
    server_name videos.nyanx.de;

    # SSL 证书配置
    ssl_certificate     /etc/letsencrypt/live/videos.nyanx.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/videos.nyanx.de/privkey.pem;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;

    # SSL 安全配置优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_ecdh_curve secp384r1;

    # 公共 DNS 设定
    resolver 1.1.1.1 8.8.8.8 valid=60s;
    resolver_timeout 5s;
    server_tokens off;

    # 根目录定义
    root /var/www/video;
    index index.html;

    # --- OpenResty 全局响应头托管 ---
    # 统一处理跨域、伪装 Server、清除后端冗余头
    header_filter_by_lua_block {
        local h = ngx.header
        -- 安全与伪装
        h["Server"] = nil
        h["X-Content-Type-Options"] = "nosniff"
        h["X-Powered-By"] = nil
        h["X-Frame-Options"] = "SAMEORIGIN"
        h["X-XSS-Protection"] = "1; mode=block"
        h["Referrer-Policy"] = "strict-origin-when-cross-origin"

        -- 核心跨域逻辑：统一由 Nginx 掌管，避免后端脚本重复发送导致报错
        h["Access-Control-Allow-Origin"] = "*"
        h["Access-Control-Allow-Methods"] = "GET, POST, OPTIONS, HEAD, RANGE"
        h["Access-Control-Allow-Headers"] = "Origin, X-Requested-With, Content-Type, Accept, Range, Authorization"
        h["Access-Control-Expose-Headers"] = "Content-Length, Content-Range, Content-Disposition"
        h["Strict-Transport-Security"] = "max-age=31536000; includeSubDomains; preload"
    }

    # --- 1. 代理源 S1 (Surrit 视频流代理) ---
    location /s1/ {
        # 拦截 OPTIONS 请求
        access_by_lua_block {
            if ngx.req.get_method() == "OPTIONS" then 
                ngx.status = 204
                ngx.header["Access-Control-Allow-Origin"] = "*"
                ngx.header["Access-Control-Allow-Methods"] = "GET, POST, OPTIONS, RANGE"
                ngx.header["Access-Control-Allow-Headers"] = "Origin, X-Requested-With, Content-Type, Accept, Range"
                ngx.header["Content-Length"] = "0"
                return ngx.exit(204)
            end
        }

        # 代理设置
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_ssl_server_name on;
        proxy_ssl_name surrit.com;
        
        # 性能优化设置
        proxy_buffering off;
        proxy_request_buffering off;  # 关闭请求缓冲，对于视频流很重要
        proxy_read_timeout 300s;      # 增加读取超时，适合视频流
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;

        # 头部伪装与 Range 透传
        proxy_set_header Host "surrit.com";
        proxy_set_header Origin "https://missav.ai";
        proxy_set_header Referer "https://missav.ai/";
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept-Encoding "";

        # URL 重写
        rewrite ^/s1/(.*)$ /$1 break;
        proxy_pass https://surrit_backend;
    }

    # --- 2. 本地 PHP 搜索接口处理 ---
    location ~ \.php$ {
        # 显式处理预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, HEAD" always;
            add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php-fpm.sock; 
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $request_filename;
        
        # 性能优化
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        fastcgi_busy_buffers_size 32k;
        fastcgi_temp_file_write_size 256k;
    }

    # --- 3. 静态文件优化 ---
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
        
        # Gzip 压缩静态资源
        gzip_static on;
        gzip_vary on;
    }

    # --- 4. 视频文件特殊处理 ---
    location ~* \.(mp4|webm|ogg|avi|mov|wmv|flv|m3u8|ts)$ {
        expires 1h;
        add_header Cache-Control "public";
        add_header X-Content-Type-Options nosniff;
        
        # 支持范围请求（断点续传）
        proxy_force_ranges on;
        proxy_request_buffering off;
        
        # 视频缓存优化
        add_header X-Cache-Status $upstream_cache_status;
    }

    # --- 5. 根目录处理 ---
    location / {
        try_files $uri $uri/ @fallback;
    }
    
    location @fallback {
        try_files /index.html =404;
    }

    # --- 6. 安全防护 ---
    # 禁止访问敏感文件
    location ~ \.(db|sqlite|sqlite3|env|conf|config|ini|log)$ {
        deny all;
        return 404;
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        return 404;
    }
    
    # 限制上传文件大小
    client_max_body_size 100M;
    
    # 防止恶意请求
    location ~ /\.ht {
        deny all;
    }
}

# --- 全局配置优化 ---
client_body_timeout 300s;
client_header_timeout 300s;
send_timeout 300s;

# Gzip 压缩优化
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types
    application/javascript
    application/x-javascript
    application/json
    text/css
    text/html
    text/xml
    text/plain
    text/x-component
    application/xml
    application/xhtml+xml
    application/rss+xml
    application/font-woff
    application/vnd.ms-fontobject
    image/svg+xml
    application/x-font-ttf
    font/opentype
    image/x-icon;
gzip_comp_level 6;
gzip_proxied any;
gzip_disable "MSIE [1-6]\.";